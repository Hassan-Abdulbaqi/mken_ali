{% if items or storage_items %}
<div class="bg-white border border-slate-200 rounded-lg shadow-lg max-h-64 md:max-h-80 overflow-y-auto">
    {% if storage_items %}
    <div class="px-2 md:px-3 py-1.5 md:py-2 bg-emerald-50 border-b border-emerald-100">
        <span class="text-xs font-semibold text-emerald-700">مواد من المخزن</span>
    </div>
    {% for item in storage_items %}
    <button type="button"
            onclick="selectStorageItem('{{ item.name|escapejs }}', '{{ item.description|escapejs }}', {{ item.quantity }}, '{{ item.department.name|escapejs }}', '{{ item.branch.name|escapejs }}')"
            class="w-full p-2 md:p-3 hover:bg-emerald-50 transition-colors text-right flex items-center gap-2 md:gap-3 border-b border-slate-100 last:border-0">
        <div class="w-7 h-7 md:w-8 md:h-8 bg-emerald-100 rounded flex items-center justify-center flex-shrink-0">
            <svg class="w-3.5 h-3.5 md:w-4 md:h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
            </svg>
        </div>
        <div class="flex-1 min-w-0">
            <p class="font-medium text-slate-800 text-sm md:text-base truncate">{{ item.name }}</p>
            <p class="text-xs text-slate-500 truncate">{{ item.department.name }} - {{ item.branch.name }}</p>
        </div>
        <div class="flex items-center gap-1 px-1.5 md:px-2 py-0.5 md:py-1 bg-emerald-100 rounded-full flex-shrink-0">
            <span class="text-xs md:text-sm font-medium text-emerald-700">{{ item.quantity }}</span>
            <span class="text-xs text-emerald-600 hidden sm:inline">متوفر</span>
        </div>
    </button>
    {% endfor %}
    {% endif %}
    
    {% if items %}
    <div class="px-2 md:px-3 py-1.5 md:py-2 bg-slate-50 border-b border-slate-100 {% if storage_items %}border-t{% endif %}">
        <span class="text-xs font-semibold text-slate-600">طلبات سابقة</span>
    </div>
    {% for item in items %}
    <button type="button"
            onclick="selectItem({{ item.id }}, '{{ item.name|escapejs }}', '{{ item.description|escapejs }}')"
            class="w-full p-2 md:p-3 hover:bg-slate-50 transition-colors text-right flex items-center gap-2 md:gap-3 border-b border-slate-100 last:border-0">
        {% if item.image %}
        <img src="{{ item.image.url }}" alt="{{ item.name }}" class="w-7 h-7 md:w-8 md:h-8 rounded object-cover flex-shrink-0">
        {% else %}
        <div class="w-7 h-7 md:w-8 md:h-8 bg-slate-100 rounded flex items-center justify-center flex-shrink-0">
            <svg class="w-3.5 h-3.5 md:w-4 md:h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
        </div>
        {% endif %}
        <div class="flex-1 min-w-0">
            <p class="font-medium text-slate-800 text-sm md:text-base truncate">{{ item.name }}</p>
            {% if item.description %}
            <p class="text-xs md:text-sm text-slate-500 truncate">{{ item.description }}</p>
            {% endif %}
        </div>
    </button>
    {% endfor %}
    {% endif %}
</div>

<script>
function selectItem(id, name, description) {
    document.querySelector('[name="item_name"]').value = name;
    document.querySelector('[name="item_description"]').value = description;
    document.querySelector('[name="existing_item_id"]').value = id;
    document.getElementById('item-suggestions').innerHTML = '';
    // Clear storage hint if any
    const hintEl = document.getElementById('storage-qty-hint');
    if (hintEl) hintEl.remove();
}

function selectStorageItem(name, description, availableQty, deptName, branchName) {
    document.querySelector('[name="item_name"]').value = name;
    document.querySelector('[name="item_description"]').value = description;
    document.querySelector('[name="existing_item_id"]').value = '';
    // Set max quantity hint
    const qtyInput = document.querySelector('[name="quantity"]');
    qtyInput.max = availableQty;
    qtyInput.title = 'الكمية المتوفرة في المخزن: ' + availableQty;
    document.getElementById('item-suggestions').innerHTML = '';
    
    // Show storage quantity hint
    let hintEl = document.getElementById('storage-qty-hint');
    if (!hintEl) {
        hintEl = document.createElement('div');
        hintEl.id = 'storage-qty-hint';
        hintEl.className = 'mt-1 text-xs md:text-sm text-emerald-600 flex items-center gap-1';
        qtyInput.parentNode.appendChild(hintEl);
    }
    hintEl.innerHTML = '<svg class="w-3.5 h-3.5 md:w-4 md:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg> الكمية المتوفرة: <strong>' + availableQty + '</strong> (' + deptName + ' - ' + branchName + ')';
}
</script>
{% endif %}
